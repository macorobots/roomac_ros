<launch>
  <arg name="pipeline" default="ompl" />
  <arg name="gazebo" default="false" />

  <!-- GDB Debug Option -->
  <arg name="debug" default="false" />
  <arg unless="$(arg debug)" name="launch_prefix" value="" />
  <arg if="$(arg debug)" name="launch_prefix" value="gdb -x $(find roomac_moveit)/launch/gdb_settings.gdb --ex run --args" />

  <!-- Verbose Mode Option -->
  <arg name="info" default="$(arg debug)" />
  <arg unless="$(arg info)" name="command_args" value="" />
  <arg if="$(arg info)" name="command_args" value="--debug" />

  <arg name="capabilities" default="" />
  <!-- load these non-default MoveGroup capabilities (space seperated) -->
  <!--
    <arg name="capabilities" value="
    a_package/AwsomeMotionPlanningCapability
    another_package/GraspPlanningPipeline
    " />
  -->

  <arg name="disable_capabilities" default="" />
  <!-- inhibit these default MoveGroup capabilities (space seperated) -->
  <!--
  <arg name="disable_capabilities" value="
                move_group/MoveGroupKinematicsService
                move_group/ClearOctomapService
                " />
  -->


  <!-- load URDF, SRDF and joint_limits configuration -->
  <include file="$(find roomac_moveit)/launch/planning_context.launch">
    <arg name="gazebo" value="$(arg gazebo)" />
  </include>

  <group ns="move_group">
    <!-- Planning Functionality -->
    <include file="$(find roomac_moveit)/launch/planning_pipeline/$(arg pipeline)_planning_pipeline.launch.xml">
      <arg name="capabilities" value="$(arg capabilities)" />
      <arg name="disable_capabilities" value="$(arg disable_capabilities)" />
    </include>

    <!-- Trajectory Execution Functionality -->
    <rosparam file="$(find roomac_moveit)/config/trajectory_execution.yaml" />
    <!-- loads ros_controllers to the param server -->
    <rosparam file="$(find roomac_moveit)/config/moveit_controllers.yaml" />
    <!-- todo is necessary? -->
    <rosparam if="$(arg gazebo)" file="$(find roomac_simulation)/config/ros_controllers.yaml" />

    <!-- Sensors Functionality -->
    <!-- Don't load kinect sensor in simulation - it makes it run slower, there are issues with detecting bottle as an obstacle.
    As there is separate table detection, octomap obstacles are not really needed, there aren't any additional 
    obstacles in the workspace of the manipulator -->
    <rosparam unless="$(arg gazebo)" command="load" file="$(find roomac_moveit)/config/sensors_3d.yaml" />
  </group>

  <!-- Start the actual move_group node/action server -->
  <node name="move_group" launch-prefix="$(arg launch_prefix)" pkg="moveit_ros_move_group" type="move_group" respawn="false" output="screen" args="$(arg command_args)">
    <!-- Set the display variable, in case OpenGL code is used internally -->
    <env name="DISPLAY" value="$(optenv DISPLAY :0)" />

    <param name="allow_trajectory_execution" value="true" />
    <param name="max_safe_path_cost" value="1" />
    <param name="jiggle_fraction" value="0.05" />

    <!-- Publish the planning scene of the physical robot so that rviz plugin can know actual robot -->
    <param name="planning_scene_monitor/publish_planning_scene" value="true" />
    <param name="planning_scene_monitor/publish_planning_scene_hz" value="10.0" />
    <param name="planning_scene_monitor/publish_geometry_updates" value="true" />
    <param name="planning_scene_monitor/publish_state_updates" value="true" />
    <param name="planning_scene_monitor/publish_transforms_updates" value="true" />

    <!-- For simulation: -->
    <remap if="$(arg gazebo)" from="/joint_states" to="/roomac/joint_states" />
    <remap if="$(arg gazebo)" from="arm_position_controller/follow_joint_trajectory" to="/roomac/arm_position_controller/follow_joint_trajectory" />
    <remap if="$(arg gazebo)" from="gripper_controller/follow_joint_trajectory" to="/roomac/gripper_controller/follow_joint_trajectory" />

    <!-- todo: it may no longer be necessary -->
    <!-- For real robot: -->
    <!-- Can't change fake execution for now, as I don't have controller defined for real robot -->
    <!-- Probably would be nice to define controller eventually -->
    <remap unless="$(arg gazebo)" from="/move_group/fake_controller_joint_states" to="/joint_states" />
  </node>
</launch>